# Лабораторная работа 1

### 43 Вариант

Хеширование документа - MD5  
Подпись документа - RSA  
Хешировани открытого ключа - RIPEMD  
Подпись открытого ключа RSA  

```python
from Crypto.Cipher import PKCS1_OAEP
from Crypto.PublicKey import RSA
from Crypto.Signature import pkcs1_15
from Crypto.Hash import MD5
from Crypto.Hash import RIPEMD160

# генерация пары ключей ЭП длиной n бит
keys = RSA.generate(n)
keys = DSA.generate(n)
keys = ECC.generate(curve='P-256')

# экспорт пары ключей ЭП для сохранения
# в формате format ('PEM' – в кодировке RFC1421/RFC1423, 'DER' – в двоичном виде),
# в зашифрованном виде (ключ шифрования закрытого ключа выводится  
# из парольной фразы passphrase),
# с использованием при записи в файл кодировки ASN.1 (предполагает кодировку DER)
# в вариантах PKCS#1 (pkcs=1) или PKCS#8 (pkcs=8),
# со схемой шифрования protection при задании PKCS#8
# (PBKDF2 с HMAC-SHA1 и DES-EDE3-CBC для кодировки DER,
# MD5 и TripleDES для кодировки PEM),
# с использованием функции генерации случайных чисел randfunc при кодировке PEM
keypair = keys.export_key(
	format='PEM',
	passphrase=None,
	pkcs=1,
	protection=None,
	randfunc=None
)

# экспорт открытого ключа ЭП для сохранения (кроме ECC)
publickey = keys.publickey().exportKey('PEM')

# экспорт открытого ключа ЭП для сохранения (ECC)
publickey = keys.export_key(format='DER')

# импорт пары ключей (например, из данных, считанных из файла)
keys = DSA.import_key(keypair,passphrase=None)
keys = RSA.import_key(keypair,passphrase=None)
keys = ECC.import_key(keypair,passphrase=None)

# хеширование данных для вычисления или проверки ЭП (кроме ECC)
myhash = SHA.new()

# хеширование данных для вычисления или проверки ЭП для ECC
myhash = SHA256.new()

# продолжение хеширования данных
myhash.update(data)

# получение вычисленного хеш-значения
myhash = myhash.digest()

# создание объекта для вычисления ЭП с заданной парой ключей
signature = pkcs1_15.new(keys)  # для RSA
signature = DSS.new(keys, 'fips-186-3') # для DSA и ECC

sig=signature.sign(myhash) # вычисление ЭП для заданного хеш-значения

# создание объекта для проверки ЭП с заданным открытым ключом
signature = pkcs1_15.new(publickey)
signature = DSS.new(pubkey, 'fips-186-3')

signature.verify(myhash,sig) # проверка ЭП с генерацией исключения ValueError  
# при неудачной проверке
```


- [ ] Приложение должно обеспечивать обмен между пользователями подписанными текстовыми документами. Приложение должно позволять редактировать текстовые документы, а также *сохранять и загружать их вместе с электронной подписью*. Для проверки подписи в приложении необходимо обеспечить хранение открытых ключей всех участников обмена сообщениями, поэтому должны быть реализованы *функции импорта/экспорта открытых ключей пользователей*. **Все открытые ключи из хранилища должны быть защищены от изменения и подмены с помощью электронной подписи пользователя при импорте такого ключа**. На рис. 1 приведена схема распределения ключей в системе при подключении к ней нового пользователя (User1)
- [ ] Редактируемая строка под надписью «Имя пользователя» предназначена для *ввода имени контейнера ключей криптопровайдера пользователя*, который обеспечивает хранение пары асимметричных ключей электронной подписи (пока имя контейнера ключей не задано, работа приложения с подписанными документами невозможна). Поле с текстовым редактором под редактируемой строкой предназначено для ввода и редактирования текстов подписанных документов. Кнопка «Выбрать пользователя» на главной форме используется для переключения на новый контейнер ключей (нового пользователя). Эта кнопка дублирует команду «Выбор закрытого ключа» меню «Управление ключами». Кнопки «Загрузить документ» и «Сохранить документ» дублируют команды «Загрузить» и «Сохранить» меню «Файл».
- [x] Команда «Создать» меню «Файл» предназначена для создания нового документа (очищается содержимое поля с текстовым редактором, а в заголовок формы помещается текст «Подписанный документ»).
- [x] Команда «Сохранить» меню «Файл» предназначена для сохранения созданного (отредактированного) документа в виде массива байт вместе с вычисляемой электронной подписью и именем автора документа в папке и файле (рекомендуется с расширением sd), выбираемыми пользователем. Структура подписанного документа приведена на рис. 5. Алгоритмы электронной подписи и хеширования массива байт документа выбираются из табл. 1 в соответствии с номером варианта студента.

![](https://lh5.googleusercontent.com/SC16jdKX6PJJTcRB7yeVMYVb8zllUo7ZYBdAJT2w033OFAcCVfx_zsJHVmVjB4lse1udZnL42LkEHBY7P9LqjIIhd14UHASpIcRy1euYYiCyK-NeQsdOTLGbikrDdh-kj3baup-rIxyQ60Xmw1l4)  
Рис. 2. Пример главной формы приложения.

 ![](https://lh3.googleusercontent.com/6XhDWbl9ZJOOYSPQEGVt_q5MlNlP3PoABIPX7FoaFcmohfGPhsw_Q1zeEcQYG3lI1Tu3A-PXBVZNj3QRnpdFCbF2r9Ybq4W48TrtS2ystjZGm9ebkHvkFjBojkPsLv9nVM3e73SR7UabunqHicTc)  
Рис. 3. Пример состава меню «Файл» приложения.

![](https://lh4.googleusercontent.com/qmRku_YL4x78WOexn5mrVbznsgSSoSbBr_w-qTHzwKGAgRtDtz3W_7w4wZ6EIYFKa-9iC99vhcbpCqgNvn3iK7EdDcTjeb_GtIxkMfpBIn7ENJ-Smf8AVl243NxrGQpx5XDyt_zxTh2KbczajZbl)  
Рис. 4. Пример состава меню «Управление ключами» приложения.

    Длина имени подписывающего пользователя  
    Длина подписи  
    Имя подписывающего пользователя  
    Электронная подпись  
    Текст документа  
    Рис. 5. Структура подписанного документа.  

- [x] Команда «Загрузить» меню «Файл» предназначена для чтения подписанного документа из папки и файла, выбираемых пользователем, извлечения из документа имени его автора, нахождения открытого ключа автора документа в хранилище открытых ключей (например, в папке с именем PK, находящейся внутри папки с приложением), проверки подписи пользователя под открытым ключом, извлечения и проверки подписи автора под документом и отображением текста проверенного документа в поле с текстовым редактором на главной форме. Имя автора проверенного документа должно отображаться в заголовке главной формы после слов «Подписанный документ». Если документ с заданным именем не найден, отсутствует открытый ключ автора документа (он не был предварительно импортирован), не подтверждаются подписи под открытым ключом или  документом, приложение должно выводить соответствующие сообщения.

- [x] Команда «Выход» меню «Файл» предназначена для завершения работы приложения. Команда «О программе» меню «Файл» предназначена для вывода формы с информацией об авторе приложения (фамилии и инициалах студента, номере учебной группы и номере варианта).

- [x] Команда «Экспорт открытого ключа» меню «Управление ключами» предназначена для сохранения открытого ключа в виде массива байт в файле с именем владельца ключа (участника системы электронного документооборота) и расширением pub. Папка для файла с экспортируемым открытым ключом выбирается пользователем. Формат открытого ключа при экспорте приведен на рис. 6.

    Длина имени владельца открытого ключа  
    Длина блоба с открытым ключом  
    Имя владельца открытого ключа  
    Блоб с открытым ключом  
    Рис. 6. Формат открытого ключа.  

- [x] Команда «Импорт открытого ключа» меню «Управление ключами» предназначена для чтения файла с ранее экспортированным открытым ключом (имя папки и файла выбираются пользователем), подписания считанных данных с помощью закрытого ключа пользователя и сохранения подписанного открытого ключа в папке-хранилище открытых ключей участников электронного документооборота (например, в папке с именем PK, находящейся внутри папки с приложением). Формат подписанного открытого ключа приведен на рис. 7. Функция импорта открытого ключа позволяет также импортировать уже подписанные ключи из хранилища открытых ключей с заменой старой подписи под ключом на заново вычисленную. Алгоритмы электронной подписи и хеширования массива байт открытого ключа выбираются из табл. 1 в соответствии с номером варианта студента.

    Длина имени владельца открытого ключа  
    Длина блоба с открытым ключом  
    Имя владельца открытого ключа  
    Блоб с открытым ключом  
    Электронная подпись  
    Рис. 7. Формат подписанного открытого ключа.  

- [x] Команда «Удаление пары ключей» меню «Управление ключами» предназначена для удаления пары асимметричных ключей электронной подписи пользователя из его контейнера в криптопровайдере и очистки редактируемой строки с именем пользователя.
    
- [x] Команда «Выбор закрытого ключа» меню «Управление ключами» предназначена для разблокирования редактируемой строки для ввода имени пользователя (имени его контейнера ключей) и перевода фокуса ввода на эту строку. После ввода имени пользователя редактируемая строка блокируется.
    
10.  После завершения разработки приложения провести его тестирование. Рекомендуемый порядок действий при тестировании:

    1. задать имя пользователя для себя;
    2. создать небольшой текстовый документ и сохранить его;
    3. экспортировать свой открытый ключ и импортировать его себе для того, чтобы иметь возможность читать и редактировать свои документы;
    4. передать файл со своим открытым ключом другим пользователям;
    5. получить другие файлы экспортируемых открытых ключей и импортировать открытые ключи других пользователей себе;
    6. получить и прочитать документы других пользователей;
    7. удалить свою ключевую пару.